name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build release binary
        run: |
          swift --version
          swift build -c release
          BIN_PATH=$(swift build -c release --show-bin-path)
          echo "BIN_PATH=$BIN_PATH" >> "$GITHUB_ENV"
          echo "Build output:" && ls "$BIN_PATH"/*.bundle || echo "No bundles found"

      - name: Assemble .app bundle
        run: |
          APP="AwesomeQuickNote.app"
          mkdir -p "$APP/Contents/MacOS"
          mkdir -p "$APP/Contents/Resources"

          # Copy binary
          cp "$BIN_PATH/AwesomeQuickNote" "$APP/Contents/MacOS/"

          # Copy Info.plist, add CFBundleExecutable, and stamp version from tag
          cp Info.plist "$APP/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string AwesomeQuickNote" "$APP/Contents/Info.plist" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable AwesomeQuickNote" "$APP/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.VERSION }}" "$APP/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.VERSION }}" "$APP/Contents/Info.plist"

          # PkgInfo
          echo -n "APPL????" > "$APP/Contents/PkgInfo"

          # Copy all SPM resource bundles
          for bundle in "$BIN_PATH"/*.bundle; do
            [ -d "$bundle" ] && cp -R "$bundle" "$APP/Contents/Resources/"
          done

          echo "App bundle contents:"
          find "$APP" -maxdepth 3 -type d

      - name: Ad-hoc code sign
        run: codesign --force --deep --sign - AwesomeQuickNote.app

      - name: Zip app
        run: ditto -c -k --keepParent AwesomeQuickNote.app AwesomeQuickNote-${{ steps.version.outputs.VERSION }}-macos.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          files: AwesomeQuickNote-${{ steps.version.outputs.VERSION }}-macos.zip
